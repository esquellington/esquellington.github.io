#+STARTUP: indent

file:laic.el

* References
- texfrag-moode
  - Enable C-c C-p C-p for preview-at-point or preview-region
  - Remove with preview-clearout-buffer
  - See file:latex.cpp for inline math in comments
  - DOES NOT WORK
    - Same issue as here https://latex.org/forum/viewtopic.php?t=27378
- See [[https://github.com/mneri/pnglatex][pnglatex]], works very well
  - Could do the same ops from elisp
  - Support math-environment as part of formula text, no point in
    having to specify it explicitly
- See http://mazack.org/unix/tex2png.php, also useful
- This explains how to create overlays and image tooltips
  http://kitchingroup.cheme.cmu.edu/blog/2016/03/21/Displaying-image-overlays-on-image-filenames-in-Emacs/
* DONE Requirements
   EASY LaTeX math preview in C/C++ comments
** Should work like texfrag-region/document, but for whole comments/functions/files
- See texfrag code, looks complex and uses auctex, which DOES NOT WORK IN
  WINDOWS
- It also uses preview for intermediate steps, which seems to be a
  generic way to do this in emacs
** 0-config, work by default
*** Avoid dependencies, try to invoke latex/dvips directly and display overlay
*** NO need to flag latex blocks, just look for $x$, $$x$$, \[x\] and \begin{}\end{} pairs like texfrag does
*** Automatic scaling of formulas to font size (should be readable by default)
** 0-interference
*** KEEP plain text edit of comments working at ALL TIMES
*** if cursor is in a formula, disable the preview while there
* DONE Call latex*dvipng to get formula image .png
- Autogen temp .tex with proper document class and includes
- Generate proper size image
- latex/dvipng/convert -trim also works for any latex "page"
- .tex must have simple structure
- .tex should have \pagestyle{empty} to avoid page number at bottom
  from stopping convert -trim
* DONE Insert .png image in Emacs buffer
- As overlay??
- Toggle between text/formula
* DONE Name it --> laic
- laic = latex-in-comments
- love = latex-overlay
- loverlay
- overlaytex
- clover = comments latex overlay
- glasstex? put them on and see formulas?
- greekvision? geek/greek vision
* DONE Set proper colors
- Set fore/background color to proper values from Emacs theme at 1st
  latex block delimiter
* DONE Extend to all formulas in a region or buffer
- Use regexp to match all delimiter pairs, and gather points begin,end
- Gen overlay image for each match
- match only in comments, not everywhere?
  - texfrag has texfrag-comments-only
* DONE Optionally run in comments only
* DONE Package as a minor mode with keybindings
** DONE public functions
** DONE Use org-sketch niceties
*** DONE create dir /laic separate form current, create temporaries there
*** DONE delete-file
*** DONE executable-find
** DONE install in /lisp
- require in init.el
- setup keybindings in init.el
- only in prog-mode-hook
** DONE Header comment block
* DONE laic-create-overlays-from-comment-inside
- All blocks in surrounding comment
* DONE Ensure non-interactive funcs do NOT CHANGE POINT
- This is a mess, many funcs change point, and we don't want to have implicit
  behaviour, so we'll save-excursion in ALL of them, and place point explicitly
  when required
* DONE Find other latex block types
- HARDCODED is fine for now
** DONE \[ \]
** DONE Custom list of begin/end delimiters
*** DONE Custom list
*** DONE For search begin/end, find closest wrt point and return list or values
- just keep MAX if backwards, and MIN if forward
** DONE Others? --> DON'T BOTHER
- $ and $$,$$ will be tricky because they're symmetric begin/end
- texfrag probably does this, check code
  - texfrag-next-frag-function
- Regexp to match region?
  - SO it seems regex CANNOT match balanced structs, so \[a\] \[b\]
    are matched as a SINGLE string, instead of 2 groups
  - Thus, we should only match the MATH_BEGIN and from there match the first
    MATH_END forward
- Probably the best commands would be
  - "convert closest not yet converted"
    - So, search back and if there's a BEGIN closer than an END, then
      search forward for an END
  - "toggle closest"
  - closest = begin/end region containing cursor, otherwise immediate next
* TODO Optimization
- it's a bit slow, so make it faster
** DONE Limit search to current best not buffer point min/max
- works but not significantly faster
** TODO Also stop searching executables for every single create overlay
** TODO Try single shell call for all exes chained, separated by ;
** org preview is SLOW first time, but FASTER successive times

Run with C-c C-x C-l (inside block for single, outside bloc for whole section)

\[ C=\|p_0-p_1\| = 0 \]
\[ \grad C = \begin{bmatrix} \pdv{C}{p_0} & \pdv{C}{p_1} \end{bmatrix} \]
\[
   \dd[4]{x} = \begin{bmatrix} a & b \\ c & d \end{bmatrix}
\]
Equation
             \begin{equation} x=y \end{equation}
Equation*
             \begin{equation*}
               \alpha = \beta
             \end{equation*}
Align*
             \begin{align*}
               \alpha &= \beta \\
               \gamma &= \delta
             \end{align*}

* TODO Add custom package list to latex header
* TODO Better overlays
** TODO laic-remove-overlays --> ONLY owned overlays
*** TODO Save in list OR assign specific property to identify laic-created overlays
*** TODO Find current/closest/next overlay with https://www.gnu.org/software/emacs/manual/html_node/elisp/Finding-Overlays.html
** TODO Consider ov package for overlay niceties
* TODO Consider tooltip instead of overlay
- This explains how to create overlays and image tooltips
  http://kitchingroup.cheme.cmu.edu/blog/2016/03/21/Displaying-image-overlays-on-image-filenames-in-Emacs/
- Less intrusive
- Optional, would work the similarly, but only inside begin/end, and render as
  tooltip, ideally of any size
- Ideally create image the SAME way, but only show it as overlay
- MUST cache it or it'll be very slow
* TODO Syntax-highlight latex blocks in comments
- Highlight subtly even when no overlay has been created, ideally subtly
  different shade of comment color, I think Org does something similar
* TODO BUGS
** TODO Foreground color is sometimes wrong
- Background is always correct though
- Could it happen on stuff not in screen only? not sure how to repro it
- If we stick to "in-comments" version, then we could just get the
  color from comment font lock properties
